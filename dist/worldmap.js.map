{"version":3,"sources":["../src/worldmap.js"],"names":["L","CIRCLE_RADIUS","POLYGON_MAGNIFY_RATIO","WorldMap","ctrl","mapContainer","validated_metrics","timeSeries","chartSeries","chartData","currentTargetForChart","currentParameterForChart","map","layerNames","layerGroup","location","parseFloat","panel","mapCenterLatitude","mapCenterLongitude","layers","getLayers","worldCopyJump","center","zoomControl","attributionControl","setZoom","initialZoom","panTo","control","zoom","position","addTo","addLayersToMap","on","id","selectedTileServer","tileServer","tileLayer","url","maxZoom","subdomains","reuseTiles","detectRetina","attribution","document","querySelector","addEventListener","event","currentTarget","value","console","debug","drawPointDetails","overlayMaps","i","length","forEach","layer","clearLayers","metrics","error","warn","Error","Object","keys","data","layerKey","objectKey","lastObjectValues","type","newIcon","createIcon","addLayer","dataPoint","layerIcon","layersIcons","layerColor","layersColors","icon","createMarker","createShape","createPopup","associateEvents","dataPointExtraFields","shape","defaultsDeep","circle","latitude","longitude","rectangle","color","polygon","elementIcon","elementColor","markerProperties","AwesomeMarkers","prefix","markerColor","marker","stickyPopupInfo","bindPopup","point","stickyLabels","openPopup","closePopup","invalidateSize","mapCenter","isADiferentCity","setNewCoords","then","flyTo","refresh","catch","mapCenterMoved","legend","removeFrom","zoomFactor","parseInt","selectedPointValues","target","options","lastValueMeasure","getTranslation","measuresMetaInfo","measure","resp","filter","measure_","toLowerCase"],"mappings":"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","file":"worldmap.js","sourcesContent":["/* eslint-disable id-length, no-unused-vars */\n\n/* Vendor specific */\nimport _ from 'lodash';\n\nimport './vendor/leaflet.awesome-markers/leaflet.awesome-markers.css!';\n\nimport * as L from './vendor/leaflet/leaflet';\nimport './vendor/leaflet.awesome-markers/leaflet.awesome-markers';\n\n/* App Specific */\nimport { TILE_SERVERS, PLUGIN_PATH } from './definitions';\nimport { \n  dataTreatment, processData, getTimeSeries, getUpdatedChartSeries,\n  drawSelect, drawPopups, renderChart, \n  hideAllGraphPopups, getDataPointExtraFields, getDataPointStickyInfo,\n  getMapMarkerClassName\n} from './utils/map_utils';\nimport { filterEmptyAndZeroValues } from './utils/data_formatter';\n\nconst CIRCLE_RADIUS = 200\nconst POLYGON_MAGNIFY_RATIO = 3\n\nexport default class WorldMap {\n\n  constructor(ctrl, mapContainer) {\n    this.ctrl = ctrl;\n    this.mapContainer = mapContainer;\n    this.validated_metrics = {};\n    this.timeSeries = {};\n    this.chartSeries = {};\n    this.chartData = [];\n    this.currentTargetForChart = null;\n    this.currentParameterForChart = null;\n    this.map = null;\n  }\n\n  getLayers() {\n    return this.ctrl.layerNames.map(elem => L.layerGroup())\n  }\n\n  createMap() {\n    let location = [ parseFloat(this.ctrl.panel.mapCenterLatitude), parseFloat(this.ctrl.panel.mapCenterLongitude) ]\n\n    this.layers = this.getLayers()\n\n    this.map = L.map(this.mapContainer, \n      {\n        worldCopyJump: true, \n        center: location,\n        zoomControl: false, \n        attributionControl: false,\n        layers: this.layers\n      })\n\n    this.map.setZoom(this.ctrl.panel.initialZoom);\n    this.map.panTo(location);\n    L.control.zoom({position: 'topright'}).addTo(this.map);\n    this.addLayersToMap();\n\n    // this.map.on('zoomstart', (e) => { mapZoom = this.map.getZoom() });\n    this.map.on('click', () => {\n      hideAllGraphPopups(this.ctrl.panel.id);\n      this.currentTargetForChart = null;\n    });\n\n    const selectedTileServer = TILE_SERVERS[this.ctrl.tileServer];\n    L.tileLayer(selectedTileServer.url, {\n      maxZoom: 18,\n      subdomains: selectedTileServer.subdomains,\n      reuseTiles: true,\n      detectRetina: true,\n      attribution: selectedTileServer.attribution\n    }).addTo(this.map, true);\n\n    document.querySelector('#parameters_dropdown_'+this.ctrl.panel.id)\n      .addEventListener('change', (event) => {\n        this.currentParameterForChart = event.currentTarget.value;\n        console.debug('selecting point for measure:')\n        console.debug(this.currentParameterForChart)\n        this.drawPointDetails();\n      }); //, {passive: true} <= to avoid blocking\n  }\n\n  addLayersToMap() {\n    this.overlayMaps = {};\n    for (let i=0; i<this.ctrl.layerNames.length; i++)\n      this.overlayMaps[this.ctrl.layerNames[i]]=this.layers[i]\n    L.control.layers({}, this.overlayMaps).addTo(this.map);\n  }\n\n  clearLayers() {\n    this.layers.forEach((layer)=>layer.clearLayers())\n  }\n\n  /* Validate metrics for a given target*/\n  setMetrics() {\n    try {\n      this.validated_metrics = this.ctrl.panel.metrics;\n    } catch(error) {\n      console.warn(error)\n      throw new Error('Please insert a valid JSON in the Metrics field (Edit > Tab Worldmap > Section AirQualityObserved - Metrics field)');\n    }\n  }\n\n  drawPoints() {\n    Object.keys(this.ctrl.data).forEach((layerKey) => {\n      let layer = this.ctrl.data[layerKey]\n\n      //for each layer\n      Object.keys(layer).forEach((objectKey) => {\n        let lastObjectValues = layer[objectKey][layer[objectKey].length-1]\n        lastObjectValues.type = layerKey\n\n        let newIcon = this.createIcon(lastObjectValues);\n\n        try { \n          if(newIcon)\n            this.overlayMaps[layerKey].addLayer(newIcon)\n        } catch(error) { console.warn(layerKey); console.warn(error) }\n      })\n    });\n  }\n\n  createIcon(dataPoint) {\n    //console.log(this.ctrl.panel.layersIcons)\n    if(!dataPoint || !dataPoint.type)\n      return null;\n    \n    let layerIcon = this.ctrl.panel.layersIcons[dataPoint.type]\n    let layerColor = this.ctrl.panel.layersColors[dataPoint.type]\n    let icon = layerIcon ? this.createMarker(dataPoint, layerIcon, layerColor) : this.createShape(dataPoint);\n\n    this.createPopup(\n      this.associateEvents(icon), \n      getDataPointStickyInfo(dataPoint, this.ctrl.panel.metrics)\n    );\n\n    return icon;\n  }\n\n  createShape(dataPoint) {\n    let dataPointExtraFields = getDataPointExtraFields(dataPoint);\n    let shape;\n\n    _.defaultsDeep(dataPointExtraFields, dataPoint)\n\n    switch(dataPoint.type) {\n      case 'AirQualityObserved':\n        shape = L.circle([dataPoint.latitude, dataPoint.longitude], CIRCLE_RADIUS, dataPointExtraFields)\n      break;\n      case 'TrafficFlowObserved':\n        shape = L.rectangle([\n            [dataPoint.latitude-(0.001*POLYGON_MAGNIFY_RATIO), dataPoint.longitude-(0.0015*POLYGON_MAGNIFY_RATIO)], \n            [dataPoint.latitude+(0.001*POLYGON_MAGNIFY_RATIO), dataPoint.longitude+(0.0015*POLYGON_MAGNIFY_RATIO)]\n          ], dataPointExtraFields)\n        //shape = L.circle([dataPoint.locationLatitude, dataPoint.locationLongitude], CIRCLE_RADIUS, dataPointExtraFields)\n      break;\n      default:\n        dataPointExtraFields.color='green'  //default color\n        shape = L.polygon([\n          [dataPoint.latitude-(0.001*POLYGON_MAGNIFY_RATIO), dataPoint.longitude-(0.0015*POLYGON_MAGNIFY_RATIO)], \n          [dataPoint.latitude+(0.001*POLYGON_MAGNIFY_RATIO), dataPoint.longitude],\n          [dataPoint.latitude-(0.001*POLYGON_MAGNIFY_RATIO), dataPoint.longitude+(0.0015*POLYGON_MAGNIFY_RATIO)],\n        ], dataPointExtraFields)\n    }\n\n    return shape;\n  }\n\n  createMarker(dataPoint, elementIcon, elementColor) {\n    let dataPointExtraFields = getDataPointExtraFields(dataPoint);\n    let location = [dataPoint.latitude, dataPoint.longitude];\n\n    let markerProperties = { \n      icon: L.AwesomeMarkers.icon(\n        { \n          icon: elementIcon,\n          prefix: 'fa',\n          markerColor: (elementColor ? elementColor : dataPointExtraFields.markerColor),\n          //spin: true,\n        }        \n      )\n    }\n    _.defaultsDeep(markerProperties, dataPoint)\n\n    return L.marker(location, markerProperties);\n  }\n\n  associateEvents(shape) {\n    return shape\n      .on('click', (event) => {this.currentTargetForChart = event})\n      .on('click', () => this.drawPointDetails())\n  }\n\n  createPopup(shape, stickyPopupInfo) {\n    shape.bindPopup(stickyPopupInfo, \n      {\n        'offset': L.point(0, -2), \n        'className': 'worldmap-popup', \n        'closeButton': this.ctrl.panel.stickyLabels\n      }\n    );\n    shape.on('mouseover', function () { this.openPopup() });\n\n    if (!this.ctrl.panel.stickyLabels) { \n      shape.on('mouseout', function () { this.closePopup() });\n    }\n  }\n\n  setTarget(event) {\n    this.currentTargetForChart = event;\n  }\n\n  resize() {\n    this.map.invalidateSize();\n  }\n\n  panToMapCenter() {\n    let location = [parseFloat(this.ctrl.panel.mapCenterLatitude), parseFloat(this.ctrl.panel.mapCenterLongitude)]\n\n    if ( this.ctrl.panel.mapCenter === 'cityenv' && this.ctrl.isADiferentCity() ) {\n      this.ctrl.setNewCoords()\n        .then(() => {\n          console.debug('flying to a new location')\n          console.debug(location)\n          this.map.flyTo(location)\n          this.ctrl.refresh();\n        })\n        .catch(error => console.warn(error))\n      return ;\n    }\n    \n    this.map.flyTo(location);\n    this.ctrl.mapCenterMoved = false;\n  }\n\n  removeLegend() {\n    this.legend.removeFrom(this.map);\n    this.legend = null;\n  }\n\n  setZoom(zoomFactor) {\n    this.map.setZoom(parseInt(zoomFactor, 10));\n  }\n\n  drawPointDetails() {\n    console.debug('drawPointDetails')\n    if(this.currentTargetForChart==null){\n      console.debug('no point selected in map')\n      return ;\n    }\n\n    let currentParameterForChart = this.currentParameterForChart || 'value'\n\n    let selectedPointValues = this.ctrl.data[this.currentTargetForChart.target.options.type][this.currentTargetForChart.target.options.id];\n    let lastValueMeasure = selectedPointValues[selectedPointValues.length - 1];\n\n    drawSelect(this.ctrl.panel.id, lastValueMeasure, this.validated_metrics, currentParameterForChart)\n\n    drawPopups(this.ctrl.panel.id, lastValueMeasure, this.validated_metrics)\n\n    renderChart(this.ctrl.panel.id, selectedPointValues, \n      getTranslation(this.validated_metrics, currentParameterForChart),\n      [\n        this.currentTargetForChart.target.options.type,\n        this.currentTargetForChart.target.options.id,\n        currentParameterForChart\n      ])\n  }\n}\n\nfunction getTranslation(measuresMetaInfo, measure) {\n  let resp = measuresMetaInfo.filter((measure_)=>measure_[0].toLowerCase()===measure.toLowerCase())\n  return resp.length>0 ? resp[0] : [measure, measure, null]\n}"]}