{"version":3,"sources":["../../src/utils/map_utils.js"],"names":["capitalize","str","charAt","toUpperCase","slice","titleize","split","map","elem","join","createLine","time_","value","time","Date","day","getDate","month","getMonth","year","getFullYear","hour","getHours","minutes","getMinutes","seconds","getSeconds","milliseconds","getMilliseconds","UTC","getCityCoordinates","city_name","url","NOMINATIM_ADDRESS","replace","fetch","then","response","json","latitude","data","lat","longitude","lon","catch","console","error","getSelectedCity","vars","cityenv_","filter","name","city","length","current","calculateAQIIndex","aqiIndex","AQI","range","forEach","index","calculateCarsIntensityIndex","CARS_COUNT","drawPopups","panel_id","lastValueMeasure","validated_metrics","currentParameterForChart","hideAllGraphPopups","drawMeasuresPopup","type","document","getElementById","style","display","drawHealthConcernsPopup","risks","color","meaning","drawTrafficFlowPopup","drawDefaultPopups","log","getDataPointExtraFields","dataPoint","values","fillOpacity","aqiColor","_","defaults","fillColor","aqiMeaning","aqiRisk","aqi","markerColor","colorIndex","getMapMarkerClassName","resp","classColor","getDataPointStickyInfo","metricsTranslations","dataPointExtraFields","stickyInfo","getDataPointDetails","translatedValues","Object","keys","dpKey","dP","trans","unit","translatedValue","renderChart","panelId","selectedPointData","measurementUnits","chartDetails","debug","pointId","fieldName","drawChartCointainer","chartData","created_at","toLowerCase","getChartMetaInfo","props","AirQualityObserved","TrafficFlowObserved","title","units","chartInfo","config","bootData","user","lightTheme","Highcharts","theme","HIGHCHARTS_THEME_DARK","setOptions","chart","height","zoomType","events","load","series","text","subtitle","xAxis","yAxis","legend","enabled","map_table_popups","map_table_popup","popup","risk","map_size","healthConcernsWrapper","healthConcerns","querySelector","healthConcernsColor","healthRisk","backgroundColor","innerHTML","getMetricsToShow","allMetrics","id","metricsToShow","key","_value","drawSelect","providedMetrics","el","firstChild","removeChild","emptyOption","createElement","appendChild","metric","newMetric","selected","selectBox","options","measuresTable","rows","deleteRow","row","insertRow","innerCell0","innerCell1","cell0","insertCell","cell1","Exporting","PANEL_DEFAULTS","TRANSLATIONS"],"mappings":"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","file":"map_utils.js","sourcesContent":["// draw components in the map\n/* Vendor specific */\nimport _ from 'lodash';\n//import Highcharts from './vendor/highcharts/highstock';\n//import \"../vendor/highcharts/highcharts.css!\";\n//import \"../vendor/highcharts/themes/dark-unica.css!\";\nimport Highcharts from \"../vendor/highcharts/highstock\";\nimport Exporting from '../vendor/highcharts/modules/exporting';\n// Initialize exporting module.\nExporting(Highcharts);\n\n/* Grafana Specific */\nimport config from 'app/core/config';\n\n/* App specific */\nimport { AQI, CARS_COUNT, NOMINATIM_ADDRESS, PANEL_DEFAULTS } from '../definitions';\nimport { HIGHCHARTS_THEME_DARK } from '../utils/highcharts/custom_themes';\n\nconst TRANSLATIONS = PANEL_DEFAULTS['metrics']\n\n\nfunction capitalize(str) {\n  return str.charAt(0).toUpperCase() + str.slice(1);\n}\n\nfunction titleize(str) {\n  return str.split('_').map((elem)=>capitalize(elem)).join(' ');\n}\n\n\n/*\n* Auxiliar functions\n*/\n// just for improve DRY\nfunction createLine(time_, value) {\n  const time = new Date(time_);\n  const day = time.getDate();\n  const month = time.getMonth();\n  const year = time.getFullYear();\n  const hour = time.getHours() - 1;\n  const minutes = time.getMinutes();\n  const seconds = time.getSeconds();\n  const milliseconds = time.getMilliseconds();\n  return [Date.UTC(year, month, day, hour+1, minutes, seconds, milliseconds), value]\n}\n\n// Access remote api and gives the coordinates from a city center based on NOMINATIM url server\nfunction getCityCoordinates(city_name) {\n  let url = NOMINATIM_ADDRESS.replace('<city_name>', city_name)\n  return fetch(url)\n    .then(response => response.json())\n    .then(data => { return { latitude: data[0].lat, longitude: data[0].lon } })\n    .catch(error => console.error(error))\n}\n\n// Given vars passed as param, retrieves the selected city\nfunction getSelectedCity(vars) {\n  let cityenv_ = vars.filter(elem => elem.name===\"cityenv\")\n  let city = null;\n  if(cityenv_ && cityenv_.length === 1)\n    city = cityenv_[0].current.value\n\n  return city;\n}\n\n// gets the aqi index from the AQI var\nfunction calculateAQIIndex(value) {\n  let aqiIndex;\n  AQI.range.forEach((elem, index) => {\n    if (value >= elem) {\n      aqiIndex = index;\n    }\n  });\n  return aqiIndex;\n}\n// gets the index from the CARS_COUNT const var\nfunction calculateCarsIntensityIndex(value) {\n  CARS_COUNT.range.forEach((elem, index) => {\n    if (value >= elem) {\n      return index;\n    }\n  });\n  return 0;\n}\n\n/*\n* View components controllers\n*/\nfunction drawPopups(panel_id, lastValueMeasure, validated_metrics, currentParameterForChart) {\n\n  //render popups\n  try {\n    // Show Metrics Legend (MAP)\n\n    //draw select\n    if(validated_metrics) {\n\n      hideAllGraphPopups(panel_id)\n\n      drawMeasuresPopup(panel_id, lastValueMeasure, validated_metrics, currentParameterForChart)\n\n      switch(lastValueMeasure.type) {\n        case 'AirQualityObserved':\n          let aqiIndex = calculateAQIIndex(lastValueMeasure.value);\n          \n          document.getElementById('environment_table_'+panel_id).style.display = 'block';\n\n          drawHealthConcernsPopup(panel_id, AQI.risks[aqiIndex], AQI.color[aqiIndex], AQI.meaning[aqiIndex]);\n     \n          break;\n        case 'TrafficFlowObserved':\n          drawTrafficFlowPopup(panel_id);\n          break;\n        default:\n          drawDefaultPopups(panel_id);\n      }\n    }\n    \n  } catch(error) {\n    console.log(\"Error:\");\n    console.log(error);\n    console.log(\"lastValueMeasure: \")\n    console.log(lastValueMeasure)\n  }\n}\n\n\nfunction getDataPointExtraFields(dataPoint) {\n\n  const values = {\n    fillOpacity: 0.5\n  }\n\n  if(dataPoint.type==='AirQualityObserved') {\n    let aqiIndex = calculateAQIIndex(dataPoint.value);\n    let aqiColor = AQI.color[aqiIndex];\n\n    _.defaults(values, {\n      color: aqiColor,\n      fillColor: aqiColor,\n\n      aqiColor: aqiColor,\n      aqiMeaning: AQI.meaning[aqiIndex],\n      aqiRisk: AQI.risks[aqiIndex],\n      aqi: dataPoint.value,\n\n      markerColor: AQI.markerColor[aqiIndex]\n    })    \n  } else {\n    if(dataPoint.type==='TrafficFlowObserved') {\n      let colorIndex = calculateCarsIntensityIndex(dataPoint.value)\n\n      _.defaults(values, {\n        color: CARS_COUNT.color[colorIndex], \n        fillColor: CARS_COUNT.color[colorIndex],\n        \n        markerColor: CARS_COUNT.markerColor[colorIndex]\n      })\n    }\n  }\n\n  return values;\n}\n\nfunction getMapMarkerClassName(type, value) {\n  let resp = 'map-marker-';\n  if(type==='AirQualityObserved') {\n    return resp+AQI.classColor[calculateAQIIndex(value)];\n  } else if(type==='TrafficFlowObserved')\n    return resp+CARS_COUNT.classColor[calculateCarsIntensityIndex(value)];\n  return resp+'default';\n}\n\nfunction getDataPointStickyInfo(dataPoint, metricsTranslations) {\n  let dataPointExtraFields = getDataPointExtraFields(dataPoint);  \n  let stickyInfo = '<div class=\"stycky-popup-info\">'\n\n  if(dataPoint.type==='AirQualityObserved') {\n    stickyInfo += '<div class=\"head air-quality\">Air Quality</div>'\n  } else {\n    if(dataPoint.type==='TrafficFlowObserved') {\n      stickyInfo += '<div class=\"head traffic-flow\">Cars Intensity</div>'\n    } else {\n      stickyInfo += '<div class=\"head\">' + dataPoint.type + '</div>'\n    }\n  }  \n\n  //body\n  stickyInfo += '<div class=\"body\">'\n  stickyInfo += getDataPointDetails(dataPoint, metricsTranslations).join('')\n  stickyInfo += '</div>'\n  stickyInfo += '</div>'\n\n  //console.debug(dataPoint)\n  return stickyInfo\n}\n\nfunction getDataPointDetails(dataPoint, metricsTranslations) {\n  let translatedValues = Object.keys(dataPoint).map((dpKey)=>{\n    let dP = dataPoint[dpKey]\n    let trans = metricsTranslations.filter((elem)=>elem[0]===dpKey)\n    return { 'name': (trans.length>0 && trans[0][1] ? trans[0][1] : titleize(dpKey) ), value: dP||'-', unit: (trans.length>0 ? trans[0][2] : '') }\n  })\n\n  return translatedValues.map((translatedValue)=>`<div>${translatedValue.name}: ${translatedValue.value} ${translatedValue.unit||''}</div>`)\n}\n\nfunction renderChart(panelId, selectedPointData, measurementUnits, chartDetails) {\n  console.debug('renderChart')\n  let [type, pointId, fieldName] = chartDetails\n\n  drawChartCointainer(panelId);\n\n  //prepare data to chart\n  let chartData = selectedPointData.map((elem)=>createLine(elem.created_at, elem[fieldName.toLowerCase()]));\n\n  function getChartMetaInfo() {\n    let props = {\n      AirQualityObserved: 'Air Quality',\n      TrafficFlowObserved: 'Cars'\n    }\n\n    return { \n        title: `${props[type]||type}: Device ${pointId} - ${measurementUnits[1]?measurementUnits[1]:titleize(measurementUnits[0])}`,\n        units: (measurementUnits[2] ? `${measurementUnits[1]} (${measurementUnits[2]})` : measurementUnits[1])\n      }\n  }\n\n\n  let chartInfo = getChartMetaInfo();\n  \n  //config highchart acording with grafana theme\n  if(!config.bootData.user.lightTheme) {\n    Highcharts.theme = HIGHCHARTS_THEME_DARK;\n\n    // Apply the theme\n    Highcharts.setOptions(Highcharts.theme);\n  }\n\n  Highcharts.chart('graph_container_'+panelId,\n    {\n      chart: {\n        type: 'line',\n        height: 200,\n        zoomType: 'x',\n        events: {\n          load: function () {            \n            chartData = this.series[0]; // set up the updating of the chart each second\n          }\n        }\n      },\n      title: {\n        text: chartInfo.title\n      },\n      subtitle: {\n        text: ''\n      },\n      xAxis: {\n        type: 'datetime'\n      },\n      yAxis: {\n        title: {\n          text: chartInfo.units\n        }\n      },\n      legend: {\n        enabled: false\n      },\n      series: [{\n        name: chartInfo.units,\n        data: chartData\n      }]\n    }\n  );\n}\n\nfunction hideAllGraphPopups(panel_id) {\n  let map_table_popups = ['measures_table', 'health_concerns_wrapper', 'environment_table', 'traffic_table'];\n\n  for(let map_table_popup of map_table_popups) {\n    let popup = document.getElementById(map_table_popup+'_'+panel_id)\n    if(popup)\n      popup.style.display = 'none';\n  }\n}\nfunction drawHealthConcernsPopup(panel_id, risk, color, meaning, map_size) {\n  const healthConcernsWrapper = document.getElementById('health_concerns_wrapper_'+panel_id);\n  const healthConcerns = document.querySelector('#health_concerns_wrapper_'+panel_id+'>div');\n  const healthConcernsColor = document.querySelector('#health_concerns_wrapper_'+panel_id+'>div>span>span.color');\n  const healthRisk = document.getElementById('health_risk_'+panel_id);\n\n  healthConcernsWrapper.style.display = 'block';\n  healthConcernsColor.style.backgroundColor = color;\n  healthRisk.innerHTML = risk;\n}\nfunction drawDefaultPopups() {  \n}\nfunction drawTrafficFlowPopup(panel_id) {\n  document.getElementById('traffic_table_'+panel_id).style.display = 'block';\n}\nfunction drawChartCointainer(panel_id) {\n  document.querySelector('#data_details_'+panel_id).style.display = 'block';\n  document.getElementById('data_chart_'+panel_id).style.display = 'block';\n}\n\n//show all accepted metrics for a specific point id\nfunction getMetricsToShow(allMetrics, id) {\n  const metricsToShow = {};\n  for (const key in allMetrics) {\n    allMetrics[key].forEach((_value) => {\n      if (_value.id === id) {\n        if (_value.value) {\n          if (!(metricsToShow[key])){\n            metricsToShow[key] = 0;\n          }\n          metricsToShow[key] = _value.value;\n        }\n      }\n    });\n  }\n\n  //  metricsToShow['aqi'] = aqi;\n  return metricsToShow\n}\n\n//render the select in the specific panel, with the specif metrics and select the option\nfunction drawSelect(panel_id, metricsToShow, providedMetrics, currentParameterForChart) {\n  // Remove air paramters from dropdown\n  let el = document.querySelector('#parameters_dropdown_'+panel_id);\n  while ( el.firstChild ) {\n    el.removeChild( el.firstChild )\n  }\n\n  //default option\n  let emptyOption = document.createElement('option');\n  emptyOption.id = 'metricsOption_'+panel_id;\n  emptyOption.value = 'value';\n  emptyOption.innerHTML = 'Select Metric';\n  el.appendChild(emptyOption);\n\n  //select population\n  Object.keys(metricsToShow).forEach((metric)=>{\n    providedMetrics.forEach((elem)=>{\n      if(elem[0] == metric) {\n        let newMetric = document.createElement('option');\n        newMetric.id = 'metricsOption_'+panel_id;\n        newMetric.value = metric.toUpperCase();\n\n        if(currentParameterForChart===newMetric.value)\n          newMetric.selected = 'selected';\n        \n        newMetric.innerHTML = elem[1]?elem[1]:titleize(elem[0]);\n\n        el.appendChild(newMetric);\n      }\n    })\n  })\n\n  let selectBox = document.querySelector('#parameters_dropdown_'+panel_id)\n  if(selectBox.options.length>0)\n    selectBox.style.display = 'block';\n}\n\nfunction drawMeasuresPopup(panel_id, metricsToShow, providedMetrics, currentParameterForChart) {\n  const measuresTable = document.querySelector('#measures_table_'+panel_id+' > table > tbody');\n  while (measuresTable.rows[0]) measuresTable.deleteRow(0);\n\n  Object.keys(metricsToShow).forEach((metric)=>{\n    providedMetrics.forEach((elem)=>{\n      if(elem[0] == metric) {\n        let row = measuresTable.insertRow();    // -1 for inserting bottom\n        let innerCell0 = elem[1]?elem[1]:titleize(elem[0]);\n        let innerCell1 = (metricsToShow[metric] ? metricsToShow[metric] : '-') + (elem[2]?` ${elem[2]}`:'');\n        let cell0 = row.insertCell(0);\n        let cell1 = row.insertCell(1);\n\n        cell0.innerHTML = innerCell0;\n        cell1.innerHTML = innerCell1;        \n      }\n    })\n\n  })\n\n  document.getElementById('measures_table_'+panel_id).style.display = 'block';\n}\n\n\n\n\nexport {\n\n  hideAllGraphPopups, \n  drawPopups,\n  drawSelect,\n  renderChart,\n\n  getCityCoordinates,\n\n  getDataPointExtraFields,\n  getDataPointStickyInfo,\n\n  getSelectedCity,\n\n  getMapMarkerClassName\n}"]}