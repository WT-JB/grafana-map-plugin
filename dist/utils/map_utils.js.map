{"version":3,"sources":["../../src/utils/map_utils.js"],"names":["Highcharts","drawPopups","panelId","lastValueMeasure","validatedMetrics","hideAllGraphPopups","document","querySelector","options","length","drawMeasuresPopup","type","aqiIndex","calculateAQIIndex","value","getElementById","style","display","drawHealthConcernsPopup","AQI","risks","color","meaning","drawTrafficFlowPopup","drawDefaultPopups","error","console","log","drawSelect","metricsToShow","providedMetrics","currentParameterForChart","el","firstChild","removeChild","metricsKeys","Object","keys","emptyOption","createElement","id","title","innerHTML","selected","appendChild","forEach","metric","elem","newMetric","toUpperCase","selectBox","renderChart","selectedPointData","measurementUnits","chartDetails","debug","pointId","fieldName","drawChartCointainer","chartData","map","convertDate","created_at","toLowerCase","getChartMetaInfo","props","AirQualityObserved","TrafficFlowObserved","units","chartInfo","config","bootData","user","lightTheme","theme","HIGHCHARTS_THEME_DARK","setOptions","chart","height","zoomType","events","load","series","text","subtitle","xAxis","yAxis","legend","enabled","name","data","getDataPointExtraFields","dataPoint","values","fillOpacity","aqiColor","fillColor","aqiMeaning","aqiRisk","aqi","markerColor","colorIndex","calculateCarsIntensityIndex","CARS_COUNT","getMapMarkerClassName","resp","classColor","getDataPointStickyInfo","metricsTranslations","dataPointExtraFields","stickyInfo","getDataPointDetails","join","translatedValues","dpKey","dP","Date","toLocaleString","trans","filter","unit","translatedValue","getSelectedCity","vars","selectedVarName","cityEnv","city","current","map_table_popups","map_table_popup","popup","risk","map_size","healthConcernsWrapper","healthConcerns","healthConcernsColor","healthRisk","backgroundColor","measuresTable","rows","deleteRow","row","insertRow","innerCell0","innerCell1","cell0","insertCell","cell1","getCityCoordinates","city_name","url","NOMINATIM_ADDRESS","replace","fetch","then","response","json","latitude","lat","longitude","lon","catch","range","index","time_","time","day","getDate","month","getMonth","year","getFullYear","hour","getHours","minutes","getMinutes","seconds","getSeconds","milliseconds","getMilliseconds","UTC","geolocationOptions","enableHighAccuracy","timeout","maximumAge"],"mappings":"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","file":"map_utils.js","sourcesContent":["// draw components in the map\n/* Vendor specific */\nimport { defaults, isEqual } from 'lodash';\n\nimport Highcharts from \"../vendor/highcharts/highcharts\";\nimport Exporting from '../vendor/highcharts/modules/exporting';\n// Initialize exporting module.\nExporting(Highcharts);\n\n/* Grafana Specific */\nimport config from 'app/core/config';\n\nimport { titleize } from './string'\n\n/* App specific */\nimport { AQI, CARS_COUNT, NOMINATIM_ADDRESS } from '../definitions';\nimport { HIGHCHARTS_THEME_DARK } from '../utils/highcharts/custom_themes';\n\n\n/*\n* Primary functions\n*/\n\n/**\n* Display popups based in the click in map's marker\n*/\nfunction drawPopups(panelId, lastValueMeasure, validatedMetrics) {\n\n  //render popups\n  try {\n    // Show Metrics Legend (MAP)\n\n    //draw select\n    if(validatedMetrics) {\n\n      hideAllGraphPopups(panelId)\n\n      if(document.querySelector('#parameters_dropdown_'+panelId).options.length>1)\n        drawMeasuresPopup(panelId, lastValueMeasure, validatedMetrics)\n\n      switch(lastValueMeasure.type) {\n        case 'AirQualityObserved':\n          let aqiIndex = calculateAQIIndex(lastValueMeasure.value);\n          \n          document.getElementById('environment_table_'+panelId).style.display = 'block';\n\n          drawHealthConcernsPopup(panelId, AQI.risks[aqiIndex], AQI.color[aqiIndex], AQI.meaning[aqiIndex]);\n     \n          break;\n        case 'TrafficFlowObserved':\n          drawTrafficFlowPopup(panelId);\n          break;\n        default:\n          drawDefaultPopups(panelId);\n      }\n    }\n    \n  } catch(error) {\n    console.log(\"Error:\");\n    console.log(error);\n    console.log(\"lastValueMeasure: \")\n    console.log(lastValueMeasure)\n  }\n}\n/*\n* Draw the select box in the specific panel, with the specif metrics and select the option\n*/\nfunction drawSelect(panelId, metricsToShow, providedMetrics, currentParameterForChart) {\n  // Remove air paramters from dropdown\n  let el = document.querySelector('#parameters_dropdown_'+panelId);\n  while ( el.firstChild ) {\n    el.removeChild( el.firstChild )\n  }\n\n  let metricsKeys = Object.keys(metricsToShow)\n\n  //default option\n  let emptyOption = document.createElement('option');\n  emptyOption.id = 'metricsOption_'+panelId;\n  emptyOption.value = 'value';\n  emptyOption.title = \"Select this to see the default field values\"\n  emptyOption.innerHTML = 'Select Metric';\n  if(metricsKeys.length===0)\n    emptyOption.selected = 'selected';\n  el.appendChild(emptyOption);\n\n  //select population\n  metricsKeys.forEach((metric)=>{\n    providedMetrics.forEach((elem)=>{\n      if(elem[0] == metric) {\n        let newMetric = document.createElement('option');\n        newMetric.id = 'metricsOption_'+panelId;\n        newMetric.value = metric.toUpperCase();\n\n        if(currentParameterForChart===newMetric.value)\n          newMetric.selected = 'selected';\n        \n        newMetric.innerHTML = elem[1]?elem[1]:titleize(elem[0]);\n\n        el.appendChild(newMetric);\n      }\n    })\n  })\n  \n  let selectBox = document.querySelector('#parameters_dropdown_'+panelId)\n  if(selectBox.options.length>0)\n    selectBox.style.display = 'block';\n}\n/**\n* Render's the chart in panel\n*/\nfunction renderChart(panelId, selectedPointData, measurementUnits, chartDetails) {\n  console.debug('renderChart')\n  let [type, pointId, fieldName] = chartDetails\n\n  drawChartCointainer(panelId);\n\n  //prepare data to chart\n  let chartData = selectedPointData.map((elem)=>[ convertDate(elem.created_at), elem[fieldName.toLowerCase()] ]);\n\n  function getChartMetaInfo() {\n    let props = {\n      AirQualityObserved: 'Air Quality',\n      TrafficFlowObserved: 'Cars'\n    }\n\n    return { \n        title: `${props[type]||type}: Device ${pointId} - ${measurementUnits[1]?measurementUnits[1]:titleize(measurementUnits[0])}`,\n        units: (measurementUnits[2] ? `${measurementUnits[1]} (${measurementUnits[2]})` : measurementUnits[1])\n      }\n  }\n\n  let chartInfo = getChartMetaInfo();\n  \n  //config highchart acording with grafana theme\n  if(!config.bootData.user.lightTheme) {\n    Highcharts.theme = HIGHCHARTS_THEME_DARK;\n\n    // Apply the theme\n    Highcharts.setOptions(Highcharts.theme);\n  }\n\n  // let chart = angular.element(\n  //     document.getElementById('graph_container_'+panelId)\n  // ).highcharts();\n\n  Highcharts.chart('graph_container_'+panelId,\n    {\n      chart: {\n        type: 'line',\n        height: 200,\n        zoomType: 'x',\n        events: {\n          load: function () {            \n            chartData = this.series[0]; // set up the updating of the chart each second\n          }\n        }\n      },\n      title: {\n        text: chartInfo.title\n      },\n      subtitle: {\n        text: ''\n      },\n      xAxis: {\n        type: 'datetime'\n      },\n      yAxis: {\n        title: {\n          text: chartInfo.units\n        }\n      },\n      legend: {\n        enabled: false\n      },\n      series: [{\n        name: chartInfo.units,\n        data: chartData\n      }]\n    }\n  );\n}\n\n\n/**\n* private functions\n*/\nfunction getDataPointExtraFields(dataPoint) {\n\n  const values = {\n    fillOpacity: 0.5\n  }\n\n  if(dataPoint.type==='AirQualityObserved') {\n    let aqiIndex = calculateAQIIndex(dataPoint.value);\n    let aqiColor = AQI.color[aqiIndex];\n\n    defaults(values, {\n      color: aqiColor,\n      fillColor: aqiColor,\n\n      aqiColor: aqiColor,\n      aqiMeaning: AQI.meaning[aqiIndex],\n      aqiRisk: AQI.risks[aqiIndex],\n      aqi: dataPoint.value,\n\n      markerColor: AQI.markerColor[aqiIndex]\n    })    \n  } else {\n    if(dataPoint.type==='TrafficFlowObserved') {\n      let colorIndex = calculateCarsIntensityIndex(dataPoint.value)\n\n      defaults(values, {\n        color: CARS_COUNT.color[colorIndex], \n        fillColor: CARS_COUNT.color[colorIndex],\n        \n        markerColor: CARS_COUNT.markerColor[colorIndex]\n      })\n    }\n  }\n\n  return values;\n}\n\nfunction getMapMarkerClassName(type, value) {\n  let resp = 'map-marker-';\n  if(type==='AirQualityObserved') {\n    return resp+AQI.classColor[calculateAQIIndex(value)];\n  } else if(type==='TrafficFlowObserved')\n    return resp+CARS_COUNT.classColor[calculateCarsIntensityIndex(value)];\n  return resp+'default';\n}\n\nfunction getDataPointStickyInfo(dataPoint, metricsTranslations) {\n  let dataPointExtraFields = getDataPointExtraFields(dataPoint);  \n  let stickyInfo = '<div class=\"stycky-popup-info\">';\n\n  if(dataPoint.type==='AirQualityObserved') {\n    stickyInfo += '<div class=\"head air-quality\">Air Quality</div>';\n  } else {\n    if(dataPoint.type==='TrafficFlowObserved') {\n      stickyInfo += '<div class=\"head traffic-flow\">Cars Intensity</div>';\n    } else {\n      stickyInfo += '<div class=\"head\">' + dataPoint.type + '</div>';\n    }\n  }  \n\n  //body\n  stickyInfo += '<div class=\"body\">';\n  stickyInfo += getDataPointDetails(dataPoint, metricsTranslations).join('');\n  stickyInfo += '</div>';\n  stickyInfo += '</div>';\n\n  //console.debug(dataPoint)\n  return stickyInfo\n}\n\nfunction getDataPointDetails(dataPoint, metricsTranslations) {\n  let translatedValues = Object.keys(dataPoint).map((dpKey)=>{\n    let dP = (dpKey==='created_at'?new Date(dataPoint[dpKey]).toLocaleString():dataPoint[dpKey]);\n    let trans = metricsTranslations.filter((elem)=>elem[0]===dpKey);\n    return { 'name': (trans.length>0 && trans[0][1] ? trans[0][1] : titleize(dpKey) ), value: dP||'-', unit: (trans.length>0 ? trans[0][2] : '') }\n  })\n  //creation of html row\n  return translatedValues.map((translatedValue)=>`<div><span>${translatedValue.name}</span><span>${translatedValue.value} ${translatedValue.unit||''}</span></div>`)\n}\n\n//show all accepted metrics for a specific point id\n// function getMetricsToShow(allMetrics, id) {\n//   const metricsToShow = {};\n//   for (const key in allMetrics) {\n//     allMetrics[key].forEach((_value) => {\n//       if (_value.id === id) {\n//         if (_value.value) {\n//           if (!(metricsToShow[key])){\n//             metricsToShow[key] = 0;\n//           }\n//           metricsToShow[key] = _value.value;\n//         }\n//       }\n//     });\n//   }\n\n//   //  metricsToShow['aqi'] = aqi;\n//   return metricsToShow\n// }\n\n// Given vars passed as param, retrieves the selected city\nfunction getSelectedCity(vars, selectedVarName) {\n  let cityEnv = vars.filter(elem => elem.name===selectedVarName)\n\n  let city = null;\n  if(cityEnv && cityEnv.length === 1)\n    city = cityEnv[0].current.value;\n\n  return city;\n}\n\nfunction hideAllGraphPopups(panelId) {\n  let map_table_popups = ['measures_table', 'health_concerns_wrapper', 'environment_table', 'traffic_table'];\n\n  for(let map_table_popup of map_table_popups) {\n    let popup = document.getElementById(map_table_popup+'_'+panelId);\n    if(popup)\n      popup.style.display = 'none';\n  }\n}\n\nfunction drawDefaultPopups() {  \n}\n/*\n* Draw Traffic Flow Popup\n*/\nfunction drawTrafficFlowPopup(panelId) {\n  document.getElementById('traffic_table_'+panelId).style.display = 'block';\n}\n/*\n* Draw Health Concerns Popup\n*/\nfunction drawHealthConcernsPopup(panelId, risk, color, meaning, map_size) {\n  const healthConcernsWrapper = document.getElementById('health_concerns_wrapper_'+panelId);\n  const healthConcerns = document.querySelector('#health_concerns_wrapper_'+panelId+'>div');\n  const healthConcernsColor = document.querySelector('#health_concerns_wrapper_'+panelId+'>div>span>span.color');\n  const healthRisk = document.getElementById('health_risk_'+panelId);\n\n  healthConcernsWrapper.style.display = 'block';\n  healthConcernsColor.style.backgroundColor = color;\n  healthRisk.innerHTML = risk;\n}\n/*\n* Draw Measures Popup - The popup info is related with the choosed value \n*  from select box and with the metrics that came from result set\n*  and from a list of what to show metrics\n*/\nfunction drawMeasuresPopup(panelId, metricsToShow, providedMetrics) {\n  const measuresTable = document.querySelector('#measures_table_'+panelId+' > table > tbody');\n  while (measuresTable.rows[0]) measuresTable.deleteRow(0);\n\n  Object.keys(metricsToShow).forEach((metric)=>{\n    providedMetrics.forEach((elem)=>{\n      if(elem[0] == metric) {\n        let row = measuresTable.insertRow();    // -1 for inserting bottom\n        let innerCell0 = elem[1]?elem[1]:titleize(elem[0]);\n        let innerCell1 = (metricsToShow[metric] ? metricsToShow[metric] : '-') + (elem[2]?` ${elem[2]}`:'');\n        let cell0 = row.insertCell(0);\n        let cell1 = row.insertCell(1);\n\n        cell0.innerHTML = innerCell0;\n        cell1.innerHTML = innerCell1;        \n      }\n    })\n\n  })\n\n  document.getElementById('measures_table_'+panelId).style.display = 'block';\n}\n/*\n* Draw Chart\n*/\nfunction drawChartCointainer(panelId) {\n  document.querySelector('#data_details_'+panelId).style.display = 'block';\n  document.getElementById('data_chart_'+panelId).style.display = 'block';\n}\n\n// Access remote api and gives the coordinates from a city center based on NOMINATIM url server\nfunction getCityCoordinates(city_name) {\n  let url = NOMINATIM_ADDRESS.replace('<city_name>', city_name)\n  return fetch(url)\n    .then(response => response.json())\n    .then(data => { return { latitude: data[0].lat, longitude: data[0].lon } })\n    .catch(error => console.error(error))\n}\n\n// gets the aqi index from the AQI var\nfunction calculateAQIIndex(value) {\n  let aqiIndex;\n  AQI.range.forEach((elem, index) => {\n    if (value >= elem) {\n      aqiIndex = index;\n    }\n  });\n  return aqiIndex;\n}\n// gets the index from the CARS_COUNT const var\nfunction calculateCarsIntensityIndex(value) {\n  CARS_COUNT.range.forEach((elem, index) => {\n    if (value >= elem) {\n      return index;\n    }\n  });\n  return 0;\n}\n\n/*\n* Auxiliar functions\n*/\n// just for improve DRY\nfunction convertDate(time_) {\n  const time = new Date(time_);\n  const day = time.getDate();\n  const month = time.getMonth();\n  const year = time.getFullYear();\n  const hour = time.getHours() - 1;\n  const minutes = time.getMinutes();\n  const seconds = time.getSeconds();\n  const milliseconds = time.getMilliseconds();\n  return Date.UTC(year, month, day, hour+1, minutes, seconds, milliseconds)\n}\n\nvar geolocationOptions = {\n  enableHighAccuracy: true,\n  timeout: 5000,\n  maximumAge: 110\n};\n\nexport {\n\n  hideAllGraphPopups, \n  drawPopups,\n  drawSelect,\n  renderChart,\n\n  getCityCoordinates,\n\n  getDataPointExtraFields,\n  getDataPointStickyInfo,\n\n  getSelectedCity,\n\n  getMapMarkerClassName,\n\n  geolocationOptions\n}"]}