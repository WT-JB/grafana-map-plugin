{"version":3,"sources":["../src/worldmap_ctrl.js"],"names":["MetricsPanelCtrl","TimeSeries","kbn","_","PLUGIN_PATH","panelDefaults","mapCenters","getDatasources","getValidDatasources","mapRenderer","DataFormatter","dataFormatter","WorldmapCtrl","$scope","$injector","contextSrv","setMapProvider","defaultsDeep","panel","events","on","onInitEditMode","bind","onDataReceived","handleDatasourceParamsChange","applyDatasourceParamsChange","addEditorTab","dataList","dashboard","snapshot","locations","snapshotLocationData","console","log","layerNames","Set","map","elem","target","split","series","seriesHandler","data","getValues","pollutants","render","snapshotData","seriesData","datapoints","alias","flotpairs","getFlotPairs","nullPointMode","datasource","remove","tileServer","user","lightTheme","setMapSaturationClass","saturationClass","mapCenter","mapCenterLatitude","mapCenterLongitude","mapCenterMoved","setZoom","initialZoom","showLegend","removeLegend","clearCircles","updateThresholdData","legend","update","scope","attrs","ctrl","templateUrl"],"mappings":"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","file":"worldmap_ctrl.js","sourcesContent":["/* eslint import/no-extraneous-dependencies: 0 */\n\n/* Grafana Specific */\nimport {MetricsPanelCtrl} from 'app/plugins/sdk';\nimport TimeSeries from 'app/core/time_series2';\nimport kbn from 'app/core/utils/kbn';\n/* Vendor specific */\nimport _ from 'lodash';\n/* App specific */\nimport { PLUGIN_PATH, panelDefaults, mapCenters } from './definitions'\nimport { getDatasources, getValidDatasources } from './utils/datasource';\nimport mapRenderer from './map_renderer';\nimport DataFormatter from './utils/data_formatter';\n\nimport './css/worldmap-panel.css!';\nimport './vendor/leaflet/leaflet.css!';\n\nlet dataFormatter = new DataFormatter(kbn);\n\nexport default class WorldmapCtrl extends MetricsPanelCtrl {\n\n  constructor($scope, $injector, contextSrv) {\n    super($scope, $injector);\n    this.setMapProvider(contextSrv);\n    _.defaultsDeep(this.panel, panelDefaults);\n\n    this.events.on('init-edit-mode', this.onInitEditMode.bind(this));\n    this.events.on('data-received', this.onDataReceived.bind(this));  //process resultset as a result of the execution of all queries\n\n    this.handleDatasourceParamsChange = this.applyDatasourceParamsChange.bind(this)\n  }\n\n\n\n  onInitEditMode() {\n    this.addEditorTab('Worldmap', `${PLUGIN_PATH}partials/editor.html`, 2);\n  }\n\n  /* \n  * Process the resultset\n  * @dataList: The resultset from the executed query \n  */\n  onDataReceived(dataList) {\n    if (!dataList) return;    //no result sets\n    if (this.dashboard.snapshot && this.locations) {\n      this.panel.snapshotLocationData = this.locations;\n    }\n\nconsole.log('dataList')\nconsole.log(dataList)\n    this.layerNames = [...new Set(dataList.map((elem)=>elem.target.split(':')[0]))]\n    this.series = dataList.map(this.seriesHandler.bind(this));\n    this.data = dataFormatter.getValues(this.series, this.panel.pollutants);\n\n\n\nconsole.log('this.data')\nconsole.log(this.data)\n\n    this.render();\n  }\n\n  onDataSnapshotLoad(snapshotData) {\n    this.onDataReceived(snapshotData);\n  }\n\n  seriesHandler(seriesData) {\n    const series = new TimeSeries({\n      datapoints: seriesData.datapoints,\n      alias: seriesData.target,\n    });\n\n    series.flotpairs = series.getFlotPairs(this.panel.nullPointMode);\n    return series;\n  }\n\n  applyDatasourceParamsChange(datasource) {\n    console.log('datasource')\n    console.log(datasource)\n    /*this.panel.pollutants=datasource.pollutants*/\n    this.render()\n  }\n\n  onPanelTeardown() {\n    if (this.map) this.map.remove();\n  }\n\n  setMapProvider(contextSrv) {\n    this.tileServer = contextSrv.user.lightTheme ? 'CartoDB Positron' : 'CartoDB Dark';\n    this.setMapSaturationClass();\n  }\n\n  setMapSaturationClass() {\n    this.saturationClass = this.tileServer === 'CartoDB Dark' ? 'map-darken' : '';    \n  }\n\n  setNewMapCenter() {\n    if (this.panel.mapCenter !== 'custom') {\n      this.panel.mapCenterLatitude = mapCenters[this.panel.mapCenter].mapCenterLatitude;\n      this.panel.mapCenterLongitude = mapCenters[this.panel.mapCenter].mapCenterLongitude;\n    }\n    this.mapCenterMoved = true;\n    this.render();\n  }\n\n  setZoom() {\n    this.map.setZoom(this.panel.initialZoom);\n  }\n\n  toggleLegend() {\n    if (!this.panel.showLegend) {\n      this.map.removeLegend();\n    }\n    this.render();\n  }\n\n  toggleStickyLabels() {\n    this.map.clearCircles();\n    this.render();\n  }\n\n  changeThresholds() {\n    this.updateThresholdData();\n    this.map.legend.update();\n    this.render();\n  }\n\n  // eslint class-methods-use-this: 0\n  link(scope, elem, attrs, ctrl) {\n    mapRenderer(scope, elem, attrs, ctrl);\n  }\n\n}\n\nWorldmapCtrl.templateUrl = 'partials/module.html';\n"]}